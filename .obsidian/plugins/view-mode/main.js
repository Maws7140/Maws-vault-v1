/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var p=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var y=Object.prototype.hasOwnProperty;var V=(d,l)=>{for(var e in l)p(d,e,{get:l[e],enumerable:!0})},C=(d,l,e,t)=>{if(l&&typeof l=="object"||typeof l=="function")for(let i of k(l))!y.call(d,i)&&i!==e&&p(d,i,{get:()=>l[i],enumerable:!(t=v(l,i))||t.enumerable});return d};var M=d=>C(p({},"__esModule",{value:!0}),d);var b={};V(b,{default:()=>h});module.exports=M(b);var n=require("obsidian"),S={metaPropertyName:"view_mode",showModeChangeNotification:!1,folderViewModes:[],customYamlNames:{read:"read_only",edit:"edit_mode",editSource:"edit_source",editPreview:"edit_preview",lock:"locked"}},h=class extends n.Plugin{constructor(){super(...arguments);this.livePreviewConfig=!0;this.lockedFiles=new Set;this.temporarilyUnlockedFiles=new Set}async onload(){await this.loadSettings(),await this.refreshEditConfig(),setTimeout(()=>{this.initializeLockedFiles(),this.updateEditButtonsVisibility()},500),this.addCommand({id:"unlock-file",name:"Unlock file",checkCallback:e=>{let t=this.app.workspace.getActiveViewOfType(n.MarkdownView);return t&&t.file&&this.isFileLocked(t.file.path)?(e||new u(this.app,this,t.file).open(),!0):!1}}),this.addSettingTab(new m(this.app,this)),this.registerEvent(this.app.workspace.on("file-open",async e=>{!e||e.extension!=="md"||setTimeout(async()=>{let t=this.app.metadataCache.getFileCache(e),i;if(t&&t.frontmatter){let o=t.frontmatter[this.settings.metaPropertyName];this.isValidViewMode(o)&&(i=this.convertYamlValueToViewMode(o))}if(i||(i=this.getFolderViewMode(e.path)),!i)return;let s=this.app.workspace.getActiveViewOfType(n.MarkdownView);!s||s.file!==e||(await this.setViewMode(s,i),this.updateEditButtonsVisibility())},100)})),this.registerEvent(this.app.workspace.on("layout-change",()=>{this.checkAndEnforceLockedFiles()})),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.checkAndEnforceLockedFiles(),this.handleLeafChange()})),this.registerEvent(this.app.workspace.on("resize",()=>{this.checkAndEnforceLockedFiles()})),this.registerInterval(window.setInterval(()=>{this.temporarilyUnlockedFiles.size===0&&this.checkAndEnforceLockedFiles(),this.updateEditButtonsVisibility()},1e3)),this.registerEvent(this.app.metadataCache.on("changed",e=>{e.extension==="md"&&setTimeout(()=>this.checkAndEnforceLockedFiles(),100)})),this.registerEvent(this.app.workspace.on("layout-change",()=>{setTimeout(()=>{let e=this.app.workspace.getActiveViewOfType(n.MarkdownView);if(e&&e.file){let t=e.file.path,i=this.lockedFiles.has(t),s=this.temporarilyUnlockedFiles.has(t);if(i&&!s){let o=e.getState();o.mode!=="preview"&&(o.mode="preview",e.setState(o,{history:!1}))}}},10)})),this.registerDomEvent(document,"click",e=>{var i,s;let t=e.target;if(t&&(t.closest(".clickable-icon")||t.closest(".view-action"))){let o=this.app.workspace.getActiveViewOfType(n.MarkdownView);if(o&&o.file&&this.isFileLocked(o.file.path)){let a=t.closest(".clickable-icon, .view-action");if(a&&((i=a.getAttribute("aria-label"))!=null&&i.includes("Edit")||(s=a.getAttribute("aria-label"))!=null&&s.includes("Preview")||a.classList.contains("view-action-edit")||a.classList.contains("view-action-preview"))){e.preventDefault(),e.stopPropagation(),new n.Notice(`File "${o.file.basename}" is locked and cannot be modified`);return}}}}),this.registerDomEvent(document,"keydown",e=>{if((e.ctrlKey||e.metaKey)&&e.key==="e"){let t=this.app.workspace.getActiveViewOfType(n.MarkdownView);if(t&&t.file&&this.isFileLocked(t.file.path)){e.preventDefault(),e.stopPropagation(),new n.Notice(`File "${t.file.basename}" is locked and cannot be modified`);return}}})}async refreshEditConfig(){var e;try{let t=JSON.parse(await this.app.vault.adapter.read(`${this.app.vault.configDir}/app.json`));this.livePreviewConfig=(e=t.livePreview)!=null?e:!0}catch(t){console.error("Error reading app config:",t),this.livePreviewConfig=!0}}getFolderViewMode(e){let t=e.substring(0,e.lastIndexOf("/"));for(let i of this.settings.folderViewModes)if(t===i.folderPath||t.startsWith(i.folderPath+"/"))return i.viewMode}isValidViewMode(e){if(typeof e=="string"){let t=this.settings.customYamlNames;return e===t.read||e===t.edit||e===t.editSource||e===t.editPreview||e===t.lock}return!1}convertYamlValueToViewMode(e){let t=this.settings.customYamlNames;if(e===t.read)return"read";if(e===t.edit)return"edit";if(e===t.editSource)return"edit-source";if(e===t.editPreview)return"edit-preview";if(e===t.lock)return"lock"}async setViewMode(e,t){var o,a,r,c,f,w;let i=t.toLowerCase(),s=e.getState();switch(this.patchViewStateMethod(e),i){case"read":s.mode="preview",this.settings.showModeChangeNotification&&new n.Notice(`File "${(o=e.file)==null?void 0:o.basename}" is in read-only mode`);break;case"edit":s.mode="source",s.source=!this.livePreviewConfig,this.settings.showModeChangeNotification&&new n.Notice(`File "${(a=e.file)==null?void 0:a.basename}" is in edit mode (${this.livePreviewConfig?"live preview":"source"})`);break;case"edit-source":s.mode="source",s.source=!0,this.settings.showModeChangeNotification&&new n.Notice(`File "${(r=e.file)==null?void 0:r.basename}" is in source edit mode`);break;case"edit-preview":s.mode="source",s.source=!1,this.settings.showModeChangeNotification&&new n.Notice(`File "${(c=e.file)==null?void 0:c.basename}" is in live preview edit mode`);break;case"lock":s.mode="preview";let g=((f=e.file)==null?void 0:f.path)||"";this.lockedFiles.add(g),this.settings.showModeChangeNotification&&new n.Notice(`File "${(w=e.file)==null?void 0:w.basename}" is locked and cannot be modified`);break;default:return}await e.setState(s,{history:!1})}checkAndEnforceLockedFiles(){let e=this.app.workspace.getActiveViewOfType(n.MarkdownView);if(!e||!e.file)return;let t=e.file.path,i=e.getState();if(this.temporarilyUnlockedFiles.has(t))return;this.lockedFiles.has(t)&&i.mode!=="preview"&&(i.mode="preview",e.setState(i,{history:!1}),new n.Notice(`File "${e.file.basename}" is locked and cannot be modified`));let s=this.app.metadataCache.getFileCache(e.file),o;if(s&&s.frontmatter){let a=s.frontmatter[this.settings.metaPropertyName];this.isValidViewMode(a)&&(o=this.convertYamlValueToViewMode(a))}if(o||(o=this.getFolderViewMode(e.file.path)),o==="lock"&&!this.lockedFiles.has(t)&&!this.temporarilyUnlockedFiles.has(t)){this.lockedFiles.add(t);let a=e.getState();a.mode!=="preview"&&(a.mode="preview",e.setState(a,{history:!1}),new n.Notice(`File "${e.file.basename}" is locked and cannot be modified`))}this.updateEditButtonsVisibility()}isFileLocked(e){return this.lockedFiles.has(e)}handleLeafChange(){this.temporarilyUnlockedFiles.size>0&&this.temporarilyUnlockedFiles.clear(),this.updateEditButtonsVisibility()}updateEditButtonsVisibility(){let e=this.app.workspace.getActiveViewOfType(n.MarkdownView);if(!e||!e.file)return;let t=this.isFileLocked(e.file.path),i=this.temporarilyUnlockedFiles.has(e.file.path);document.querySelectorAll('.view-action-edit, .view-action-preview, .clickable-icon[aria-label*="Edit"], .clickable-icon[aria-label*="Preview"]').forEach(o=>{let a=o;t&&!i?a.classList.add("view-mode-hidden"):a.classList.remove("view-mode-hidden")})}patchViewStateMethod(e){let t=e;t._originalSetState||(t._originalSetState=e.setState.bind(e),e.setState=async(i,s)=>{var a,r;let o=(a=e.file)==null?void 0:a.path;return o&&this.lockedFiles.has(o)&&!this.temporarilyUnlockedFiles.has(o)&&i.mode&&i.mode!=="preview"&&(i.mode="preview",new n.Notice(`File "${(r=e.file)==null?void 0:r.basename}" is locked and cannot be modified`)),await t._originalSetState(i,s)})}unlockFile(e){this.lockedFiles.delete(e),this.temporarilyUnlockedFiles.add(e);let t=this.app.workspace.getActiveViewOfType(n.MarkdownView);if(t&&t.file&&t.file.path===e){let i=t.getState();i.mode="source",i.source=!this.livePreviewConfig,t.setState(i,{history:!1})}this.updateEditButtonsVisibility()}initializeLockedFiles(){this.app.workspace.getLeavesOfType("markdown").forEach(t=>{let i=t.view;if(i&&i.file){let s=this.app.metadataCache.getFileCache(i.file),o;if(s&&s.frontmatter){let a=s.frontmatter[this.settings.metaPropertyName];this.isValidViewMode(a)&&(o=this.convertYamlValueToViewMode(a))}if(o||(o=this.getFolderViewMode(i.file.path)),o==="lock"){this.lockedFiles.add(i.file.path);let a=i.getState();a.mode!=="preview"&&(a.mode="preview",i.setState(a,{history:!1}),this.settings.showModeChangeNotification&&new n.Notice(`File "${i.file.basename}" is locked and cannot be modified`))}}})}onunload(){this.lockedFiles.clear(),this.temporarilyUnlockedFiles.clear()}async loadSettings(){this.settings=Object.assign({},S,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},u=class extends n.Modal{constructor(e,t,i){super(e);this.plugin=t,this.file=i}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("unlock-file-modal"),e.createEl("h2",{text:"Unlock file"}),e.createEl("p",{text:"Are you sure you want to unlock the file?"}),e.createEl("p",{text:"The file will return to its locked state when you navigate away.",cls:"modal-subnote"});let t=e.createEl("div",{cls:"modal-button-container"}),i=t.createEl("button",{text:"Cancel"});i.addEventListener("click",()=>{this.close()}),t.createEl("button",{text:"Unlock",cls:"mod-cta"}).addEventListener("click",()=>{this.close(),this.unlockFile()}),i.focus()}onClose(){let{contentEl:e}=this;e.empty()}unlockFile(){this.plugin.unlockFile(this.file.path),new n.Notice(`File "${this.file.basename}" has been unlocked`)}},m=class extends n.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.addClass("view-mode-settings"),e.createEl("h3",{text:"File View Mode Settings"}),e.createEl("p",{text:"Configure view modes for specific folders. Files in these folders will automatically use the specified view mode unless overridden by frontmatter.",cls:"setting-item-description"}),new n.Setting(e).setName("Meta property name").setDesc('The YAML frontmatter property name used to control view mode. Default is "view_mode". Examples: "ViewStyle", "view-format", "mode", etc.').addText(s=>s.setPlaceholder("view_mode").setValue(this.plugin.settings.metaPropertyName).onChange(async o=>{this.plugin.settings.metaPropertyName=o,await this.plugin.saveSettings()}));let t=e.createEl("div",{cls:"custom-yaml-section"});t.createEl("h4",{text:"Custom YAML Property Names"}),t.createEl("p",{text:"Configure custom YAML property values for each view mode. These values will be used in your frontmatter instead of the default values.",cls:"setting-item-description"}),new n.Setting(t).setName("Read Only Mode").setDesc("YAML value for read-only mode").addText(s=>s.setPlaceholder("read").setValue(this.plugin.settings.customYamlNames.read).onChange(async o=>{this.plugin.settings.customYamlNames.read=o,await this.plugin.saveSettings()})),new n.Setting(t).setName("Edit Mode").setDesc("YAML value for edit mode (user preference)").addText(s=>s.setPlaceholder("edit").setValue(this.plugin.settings.customYamlNames.edit).onChange(async o=>{this.plugin.settings.customYamlNames.edit=o,await this.plugin.saveSettings()})),new n.Setting(t).setName("Edit Source Mode").setDesc("YAML value for source edit mode").addText(s=>s.setPlaceholder("edit-source").setValue(this.plugin.settings.customYamlNames.editSource).onChange(async o=>{this.plugin.settings.customYamlNames.editSource=o,await this.plugin.saveSettings()})),new n.Setting(t).setName("Edit Preview Mode").setDesc("YAML value for live preview edit mode").addText(s=>s.setPlaceholder("edit-preview").setValue(this.plugin.settings.customYamlNames.editPreview).onChange(async o=>{this.plugin.settings.customYamlNames.editPreview=o,await this.plugin.saveSettings()})),new n.Setting(t).setName("Lock Mode").setDesc("YAML value for locked mode").addText(s=>s.setPlaceholder("lock").setValue(this.plugin.settings.customYamlNames.lock).onChange(async o=>{this.plugin.settings.customYamlNames.lock=o,await this.plugin.saveSettings()})),new n.Setting(e).setName("Show mode change notification").setDesc("When enabled, shows a notification when the view mode changes. When disabled, mode changes happen silently without notifications.").addToggle(s=>s.setValue(this.plugin.settings.showModeChangeNotification).onChange(async o=>{this.plugin.settings.showModeChangeNotification=o,await this.plugin.saveSettings()})),e.createEl("h4",{text:"Folder View Modes"}),e.createEl("p",{text:"Configure view modes for specific folders. Files in these folders will automatically use the specified view mode unless overridden by frontmatter.",cls:"setting-item-description"}),this.plugin.settings.folderViewModes.forEach((s,o)=>{new n.Setting(e).setName(`Folder ${o+1}`).addText(r=>r.setPlaceholder("e.g., Daily Notes, Projects/Work").setValue(s.folderPath).onChange(async c=>{s.folderPath=c,await this.plugin.saveSettings()})).addDropdown(r=>r.addOption("read","Read Only").addOption("edit","Edit (User Preference)").addOption("edit-source","Edit Source").addOption("edit-preview","Edit Preview").addOption("lock","Lock (Cannot be modified)").setValue(s.viewMode).onChange(async c=>{s.viewMode=c,await this.plugin.saveSettings()})).addExtraButton(r=>r.setIcon("trash").setTooltip("Remove folder").onClick(async()=>{this.plugin.settings.folderViewModes.splice(o,1),await this.plugin.saveSettings(),this.display()})).settingEl.addClass("folder-view-mode-item")}),new n.Setting(e).setName("Add Folder").setDesc("Add a new folder with a specific view mode").addButton(s=>s.setButtonText("+ Add folder").onClick(async()=>{this.plugin.settings.folderViewModes.push({folderPath:"",viewMode:"read"}),await this.plugin.saveSettings(),this.display()})).settingEl.addClass("add-folder-button")}};
